<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Role Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .main-content {
      display: none;
    }
    .auth-form {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 400px;
    }
    .member-card {
      margin-bottom: 15px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }
    .role-badge {
      margin: 2px;
      font-size: 0.85rem;
    }
    .member-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .search-container {
      position: sticky;
      top: 0;
      background: white;
      z-index: 100;
      padding: 1rem 0;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 1rem;
    }
    .members-container {
      max-height: 70vh;
      overflow-y: auto;
    }
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
  </style>
</head>
<body>
  <!-- Authentication Overlay -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-form">
      <h3 class="text-center mb-4">üîê Admin Authentication</h3>
      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Restricted Access</strong><br>
        This admin panel is restricted to authorized IP addresses only.
      </div>
      <form id="authForm">
        <div class="mb-3">
          <label for="apiKey" class="form-label">Enter API Key:</label>
          <input type="password" class="form-control" id="apiKey" placeholder="Enter your secret key" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">Authenticate</button>
      </form>
      <div id="authError" class="alert alert-danger mt-3" style="display: none;"></div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="main-content">
    <div class="container-fluid mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üõ°Ô∏è Admin Panel - Role Management</h1>
        <div>
          <a href="/" class="btn btn-outline-secondary me-2">üìã Reaction Roles</a>
          <button id="logoutBtn" class="btn btn-outline-danger btn-sm">üîì Logout</button>
        </div>
      </div>

      <!-- Server Selection -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>Select Server</h5>
            </div>
            <div class="card-body">
              <select class="form-select" id="guildSelect">
                <option selected disabled>Choose a server...</option>
              </select>
              <div class="mt-3">
                <button id="loadMembersBtn" class="btn btn-primary" disabled>Load Members</button>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h5>Server Info</h5>
            </div>
            <div class="card-body">
              <div id="serverInfo">
                <p class="text-muted">Select a server to view information</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Members Management -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>Members & Role Management</h5>
            </div>
            <div class="card-body">
              <div id="membersSection" style="display: none;">
                <div class="search-container">
                  <div class="row">
                    <div class="col-md-6">
                      <input type="text" class="form-control" id="memberSearch" placeholder="üîç Search members by name...">
                    </div>
                    <div class="col-md-6">
                      <select class="form-select" id="roleFilter">
                        <option value="">Filter by role (all)</option>
                      </select>
                    </div>
                  </div>
                </div>
                
                <div id="membersContainer" class="members-container">
                  <!-- Members will be loaded here -->
                </div>
              </div>
              
              <div id="loadingSection" style="display: none;">
                <div class="loading-spinner">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <span class="ms-3">Loading members...</span>
                </div>
              </div>
              
              <div id="noServerSelected">
                <p class="text-muted text-center">Select a server and click "Load Members" to manage roles</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global variables
    let apiKey = null;
    let currentGuild = null;
    let allMembers = [];
    let filteredMembers = [];

    // Authentication functions
    function showAuthOverlay() {
      document.getElementById('authOverlay').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
    }

    function hideAuthOverlay() {
      document.getElementById('authOverlay').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    }

    function showAuthError(message) {
      const errorDiv = document.getElementById('authError');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function hideAuthError() {
      document.getElementById('authError').style.display = 'none';
    }

    // Enhanced fetch function that includes API key
    function authenticatedFetch(url, options = {}) {
      if (!apiKey) {
        throw new Error('No API key available');
      }

      const headers = {
        'Content-Type': 'application/json',
        'X-API-Key': apiKey,
        ...options.headers
      };

      return fetch(url, {
        ...options,
        headers
      });
    }

    // Authentication form handler
    document.getElementById('authForm').addEventListener('submit', function(e) {
      e.preventDefault();
      hideAuthError();
      
      const inputKey = document.getElementById('apiKey').value.trim();
      if (!inputKey) {
        showAuthError('Please enter an API key');
        return;
      }

      // Verify the API key
      fetch('/api/auth/verify', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': inputKey
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.valid) {
          apiKey = inputKey;
          localStorage.setItem('discord_bot_api_key', inputKey);
          hideAuthOverlay();
          initializeApp();
        } else {
          showAuthError('Invalid API key or access denied');
        }
      })
      .catch(error => {
        console.error('Auth error:', error);
        showAuthError('Authentication failed or IP not authorized');
      });
    });

    // Logout function
    document.getElementById('logoutBtn').addEventListener('click', function() {
      apiKey = null;
      localStorage.removeItem('discord_bot_api_key');
      showAuthOverlay();
      document.getElementById('apiKey').value = '';
      hideAuthError();
    });

    // Check for stored API key on page load
    document.addEventListener('DOMContentLoaded', function() {
      const storedKey = localStorage.getItem('discord_bot_api_key');
      if (storedKey) {
        // Verify stored key
        fetch('/api/auth/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': storedKey
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.valid) {
            apiKey = storedKey;
            hideAuthOverlay();
            initializeApp();
          } else {
            localStorage.removeItem('discord_bot_api_key');
            showAuthOverlay();
          }
        })
        .catch(error => {
          console.error('Stored key verification failed:', error);
          localStorage.removeItem('discord_bot_api_key');
          showAuthOverlay();
        });
      } else {
        showAuthOverlay();
      }
    });

    // Main application initialization
    function initializeApp() {
      loadGuilds();
      setupEventListeners();
    }

    // Load Discord guilds
    function loadGuilds() {
      authenticatedFetch('/api/discord/resources')
        .then(response => response.json())
        .then(guilds => {
          const guildSelect = document.getElementById('guildSelect');
          guildSelect.innerHTML = '<option selected disabled>Choose a server...</option>';
          
          guilds.forEach(guild => {
            const option = document.createElement('option');
            option.value = guild.id;
            option.textContent = guild.name;
            option.dataset.guild = JSON.stringify(guild);
            guildSelect.appendChild(option);
          });
          
          guildSelect.disabled = false;
        })
        .catch(error => {
          console.error('Error loading guilds:', error);
          alert('Failed to load Discord servers.');
        });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Guild selection
      document.getElementById('guildSelect').addEventListener('change', function() {
        const selectedGuild = JSON.parse(this.options[this.selectedIndex].dataset.guild);
        currentGuild = selectedGuild;
        
        // Update server info
        const serverInfo = document.getElementById('serverInfo');
        serverInfo.innerHTML = `
          <h6>${selectedGuild.name}</h6>
          <p><strong>Roles:</strong> ${selectedGuild.roles.length}</p>
          <p><strong>Channels:</strong> ${selectedGuild.channels.length}</p>
        `;
        
        // Enable load members button
        document.getElementById('loadMembersBtn').disabled = false;
        
        // Hide members section
        document.getElementById('membersSection').style.display = 'none';
        document.getElementById('noServerSelected').style.display = 'block';
        
        // Populate role filter
        const roleFilter = document.getElementById('roleFilter');
        roleFilter.innerHTML = '<option value="">Filter by role (all)</option>';
        selectedGuild.roles.forEach(role => {
          const option = document.createElement('option');
          option.value = role.id;
          option.textContent = role.name;
          roleFilter.appendChild(option);
        });
      });

      // Load members button
      document.getElementById('loadMembersBtn').addEventListener('click', loadMembers);

      // Search functionality
      document.getElementById('memberSearch').addEventListener('input', filterMembers);
      document.getElementById('roleFilter').addEventListener('change', filterMembers);
    }

    // Load guild members
    function loadMembers() {
      if (!currentGuild) return;
      
      document.getElementById('loadingSection').style.display = 'block';
      document.getElementById('membersSection').style.display = 'none';
      document.getElementById('noServerSelected').style.display = 'none';
      
      authenticatedFetch(`/api/admin/guild/${currentGuild.id}/members`)
        .then(response => response.json())
        .then(members => {
          allMembers = members;
          filteredMembers = members;
          
          document.getElementById('loadingSection').style.display = 'none';
          document.getElementById('membersSection').style.display = 'block';
          
          renderMembers();
        })
        .catch(error => {
          console.error('Error loading members:', error);
          document.getElementById('loadingSection').style.display = 'none';
          alert('Failed to load members. Check console for details.');
        });
    }

    // Filter members based on search and role filter
    function filterMembers() {
      const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
      const roleFilter = document.getElementById('roleFilter').value;
      
      filteredMembers = allMembers.filter(member => {
        const matchesSearch = member.username.toLowerCase().includes(searchTerm) ||
                            member.displayName.toLowerCase().includes(searchTerm);
        
        const matchesRole = !roleFilter || member.roles.some(role => role.id === roleFilter);
        
        return matchesSearch && matchesRole;
      });
      
      renderMembers();
    }

    // Render members list
    function renderMembers() {
      const container = document.getElementById('membersContainer');
      
      if (filteredMembers.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No members found matching the criteria</p>';
        return;
      }
      
      container.innerHTML = '';
      
      filteredMembers.forEach(member => {
        const memberCard = createMemberCard(member);
        container.appendChild(memberCard);
      });
    }

    // Create member card HTML
    function createMemberCard(member) {
      const card = document.createElement('div');
      card.className = 'member-card p-3';
      
      const rolesHtml = member.roles.map(role => `
        <span class="badge role-badge" style="background-color: ${role.color || '#6c757d'}; color: ${getContrastColor(role.color || '#6c757d')};">
          ${role.name}
          <button class="btn-close btn-close-white ms-1" style="font-size: 0.6rem;" onclick="removeRole('${member.id}', '${role.id}', '${role.name}', this)" title="Remove role"></button>
        </span>
      `).join('');
      
      card.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <div class="member-avatar bg-secondary d-flex align-items-center justify-content-center text-white">
                ${member.username.charAt(0).toUpperCase()}
              </div>
            </div>
            <div>
              <h6 class="mb-1">${member.displayName}</h6>
              <small class="text-muted">@${member.username}</small>
            </div>
          </div>
          <div class="text-end">
            <button class="btn btn-sm btn-outline-primary" onclick="showAddRoleModal('${member.id}', '${member.displayName}')">
              ‚ûï Add Role
            </button>
          </div>
        </div>
        <div class="mt-2">
          <strong>Roles:</strong><br>
          ${rolesHtml || '<span class="text-muted">No roles</span>'}
        </div>
      `;
      
      return card;
    }

    // Get contrast color for text on colored background
    function getContrastColor(hexcolor) {
      if (!hexcolor || hexcolor === '#000000') return '#ffffff';
      
      // Remove # if present
      hexcolor = hexcolor.replace('#', '');
      
      // Convert to RGB
      const r = parseInt(hexcolor.substr(0, 2), 16);
      const g = parseInt(hexcolor.substr(2, 2), 16);
      const b = parseInt(hexcolor.substr(4, 2), 16);
      
      // Calculate luminance
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      
      return luminance > 0.5 ? '#000000' : '#ffffff';
    }

    // Remove role from member
    function removeRole(memberId, roleId, roleName, buttonElement) {
      if (!confirm(`Remove role "${roleName}" from this member?`)) {
        return;
      }
      
      const badge = buttonElement.closest('.role-badge');
      badge.style.opacity = '0.5';
      buttonElement.disabled = true;
      
      authenticatedFetch(`/api/admin/guild/${currentGuild.id}/member/${memberId}/role/${roleId}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remove from local data
          const member = allMembers.find(m => m.id === memberId);
          if (member) {
            member.roles = member.roles.filter(role => role.id !== roleId);
          }
          
          // Re-render
          filterMembers();
          
          // Show success message
          showMessage(`Role "${roleName}" removed successfully!`, 'success');
        } else {
          badge.style.opacity = '1';
          buttonElement.disabled = false;
          alert('Failed to remove role: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error removing role:', error);
        badge.style.opacity = '1';
        buttonElement.disabled = false;
        alert('Failed to remove role. Check console for details.');
      });
    }

    // Show add role modal
    function showAddRoleModal(memberId, displayName) {
      const member = allMembers.find(m => m.id === memberId);
      if (!member) return;
      
      const memberRoleIds = member.roles.map(role => role.id);
      const availableRoles = currentGuild.roles.filter(role => !memberRoleIds.includes(role.id));
      
      if (availableRoles.length === 0) {
        alert('This member already has all available roles.');
        return;
      }
      
      const roleOptions = availableRoles.map(role => 
        `<option value="${role.id}">${role.name}</option>`
      ).join('');
      
      const modalHtml = `
        <div class="modal fade" id="addRoleModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add Role to ${displayName}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="addRoleForm">
                  <div class="mb-3">
                    <label for="roleSelect" class="form-label">Select Role:</label>
                    <select class="form-select" id="roleSelect" required>
                      <option value="">Choose a role...</option>
                      ${roleOptions}
                    </select>
                  </div>
                  <button type="submit" class="btn btn-primary">Add Role</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('addRoleModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Setup form handler
      document.getElementById('addRoleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const roleId = document.getElementById('roleSelect').value;
        if (roleId) {
          addRoleToMember(memberId, roleId);
        }
      });
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('addRoleModal'));
      modal.show();
    }

    // Add role to member
    function addRoleToMember(memberId, roleId) {
      const role = currentGuild.roles.find(r => r.id === roleId);
      if (!role) return;
      
      authenticatedFetch(`/api/admin/guild/${currentGuild.id}/member/${memberId}/role/${roleId}`, {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Add to local data
          const member = allMembers.find(m => m.id === memberId);
          if (member) {
            member.roles.push(role);
          }
          
          // Re-render
          filterMembers();
          
          // Hide modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('addRoleModal'));
          modal.hide();
          
          // Show success message
          showMessage(`Role "${role.name}" added successfully!`, 'success');
        } else {
          alert('Failed to add role: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error adding role:', error);
        alert('Failed to add role. Check console for details.');
      });
    }

    // Show temporary message
    function showMessage(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 3000);
    }
  </script>
</body>
</html>
